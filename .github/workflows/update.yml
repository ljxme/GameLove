name: Update GameLove Hosts

on:
  schedule:
    # æ¯å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°'
        required: false
        default: 'false'
        type: boolean

jobs:
  update-hosts:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ç”Ÿæˆ hosts æ–‡ä»¶
      run: |
        cd scripts
        python update_hosts.py \
          --workers 32 \
          --dns-timeout 0.6 \
          --race-workers 8 \
          --latency-timeout 0.4 \
          --latency-workers 24 \
          --max-ip-probes 2 \
          --health-retry-base 0 \
          --health-fail-threshold 4

    - name: æ‰§è¡Œè¿é€šæ€§æµ‹è¯•å¹¶ç”ŸæˆæŠ¥å‘Š
      run: |
        python scripts/connectivity/test_connectivity.py
    
    - name: æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
      id: check_changes
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "å‘ç°æ–‡ä»¶å˜æ›´"
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ–‡ä»¶å˜æ›´"
        fi
    
    - name: æäº¤æ›´æ–°
      if: steps.check_changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "ğŸ® è‡ªåŠ¨æ›´æ–° GameLove hosts æ–‡ä»¶ - $(date '+%Y-%m-%d %H:%M:%S')"
        git push origin main
    
    - name: è·å–å½“å‰æ—¶é—´
      id: date
      if: steps.check_changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true'
      run: |
        # è®¾ç½®åŒ—äº¬æ—¶é—´ (UTC+8)
        echo "date=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        echo "tag_date=$(TZ='Asia/Shanghai' date '+%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT

    - name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
      if: steps.check_changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: GameLove-Hosts-${{ steps.date.outputs.tag_date }}
        name: GameLove Hosts [${{ steps.date.outputs.date }}]
        body: |
          ğŸ® GameLove æ¸¸æˆå¹³å°ç½‘ç»œä¼˜åŒ– - è‡ªåŠ¨æ›´æ–°
          
          ğŸ“… æ›´æ–°æ—¶é—´: ${{ steps.date.outputs.date }}
          ğŸ”„ æ›´æ–°æ–¹å¼: è‡ªåŠ¨æ›´æ–°
          âš ï¸ æ³¨æ„: åªä¿ç•™æœ€æ–°ç‰ˆæœ¬ï¼Œæ—§ç‰ˆæœ¬ä¼šè‡ªåŠ¨æ¸…ç†
          
          ## ğŸ” è¿é€šæ€§æŠ¥å‘Š
          
          ![Connectivity Badge](https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/connectivity/connectivity_badge.svg)
          
          åˆ†å±‚è¿é€šæ€§æŠ¥å‘Šï¼ˆTCPâ†’TLSâ†’HTTPï¼‰ï¼Œå¾½ç« æ˜¾ç¤º TLS æˆåŠŸç‡ã€‚
          
          
          å¯é€šè¿‡ Raw æ–¹å¼ç›´æ¥è®¿é—®ï¼š
          - [CONNECTIVITY.md](https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/connectivity/CONNECTIVITY.md)
          - [connectivity_results.json](https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/connectivity/connectivity_results.json)
          
          ## ğŸ“¥ å¿«é€Ÿä½¿ç”¨
          
          ### æ–¹æ³•ä¸€ï¼šç›´æ¥ä¸‹è½½
          ```bash
          # Windows (ç®¡ç†å‘˜æƒé™)
          curl -o C:\Windows\System32\drivers\etc\hosts https://raw.githubusercontent.com/${{ github.repository }}/main/hosts
          
          # Linux/Mac
          sudo curl -o /etc/hosts https://raw.githubusercontent.com/${{ github.repository }}/main/hosts
          ```
          
          ### æ–¹æ³•äºŒï¼š[SwitchHosts](https://github.com/oldj/SwitchHosts)
          - URL: `https://raw.githubusercontent.com/${{ github.repository }}/main/hosts`
          - è‡ªåŠ¨åˆ·æ–°: 1å°æ—¶
          
          ## ğŸ¯ æ”¯æŒå¹³å°
          - Steam
          - Epic Games
          - Origin (EA)
          - Uplay (Ubisoft)
          - Battle.net (Blizzard)
          - GOG
          - Rockstar Games
          
          è®©ä½ "çˆ±"ä¸Šæ¸¸æˆï¼Œè§£å†³è®¿é—®æ…¢ã€è¿æ¥è¶…æ—¶çš„é—®é¢˜ï¼
        # æœ¬æ¬¡å‘å¸ƒä¸é™„åŠ ä»»ä½•è¿é€šæ€§æŠ¥å‘Šé™„ä»¶
        draft: false
        prerelease: false

    - name: æ¸…ç†æ—§ç‰ˆæœ¬ä¸æ ‡ç­¾ï¼ˆä»…ä¿ç•™æœ€æ–°ï¼‰
      if: steps.check_changes.outputs.has_changes == 'true' || github.event.inputs.force_update == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # è·å–æ‰€æœ‰ä»¥ GameLove-Hosts- å¼€å¤´çš„å‘å¸ƒç‰ˆæœ¬ï¼ŒæŒ‰åˆ›å»ºæ—¶é—´æ’åº
        releases=$(gh release list --repo ${{ github.repository }} --limit 100 --json tagName,createdAt | \
          jq -r '.[] | select(.tagName | startswith("GameLove-Hosts-")) | .tagName' | \
          head -n 100)
        
        # è®¡ç®—éœ€è¦åˆ é™¤çš„ç‰ˆæœ¬æ•°é‡
        total_count=$(echo "$releases" | wc -l)
        keep_count=1
        
        if [ $total_count -gt $keep_count ]; then
          delete_count=$((total_count - keep_count))
          echo "æ€»å…±æœ‰ $total_count ä¸ªç‰ˆæœ¬ï¼Œä¿ç•™æœ€æ–° $keep_count ä¸ªï¼Œåˆ é™¤å…¶ä½™ $delete_count ä¸ª"
          
          # è·å–éœ€è¦åˆ é™¤çš„ç‰ˆæœ¬ï¼ˆæœ€æ—§çš„å‡ ä¸ªï¼‰
          old_releases=$(echo "$releases" | tail -n $delete_count)
          
          # åˆ é™¤æ—§ç‰ˆæœ¬
          for tag in $old_releases; do
            echo "åˆ é™¤ç‰ˆæœ¬: $tag"
            gh release delete "$tag" --repo ${{ github.repository }} --yes --cleanup-tag || echo "åˆ é™¤ $tag æˆ–å…¶ Tag å¤±è´¥ï¼Œå¯èƒ½å·²è¢«åˆ é™¤"
          done
        else
          echo "å½“å‰ç‰ˆæœ¬æ•°é‡: $total_countï¼Œæ— éœ€æ¸…ç†ï¼ˆä»…ä¿ç•™æœ€æ–°ç‰ˆæœ¬ç­–ç•¥ï¼‰"
        fi
